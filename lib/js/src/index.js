// Generated by BUCKLESCRIPT VERSION 2.1.0, PLEASE EDIT WITH CARE
'use strict';

var Fs            = require("fs");
var Os            = require("os");
var List          = require("bs-platform/lib/js/list.js");
var $$Array       = require("bs-platform/lib/js/array.js");
var Block         = require("bs-platform/lib/js/block.js");
var Curry         = require("bs-platform/lib/js/curry.js");
var Utils         = require("./utils.js");
var Result        = require("./result.js");
var $$String      = require("bs-platform/lib/js/string.js");
var Process       = require("process");
var Brewconfig    = require("./brewconfig.js");
var Child_process = require("child_process");

var installBrewScript = "/usr/bin/ruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\"";

var installCaskScript = "brew tap caskroom/cask";

function commandToString(command) {
  switch (command) {
    case 0 : 
        return "help";
    case 1 : 
        return "unknown";
    case 2 : 
        return "install";
    case 3 : 
        return "init";
    case 4 : 
        return "list";
    case 5 : 
        return "uninstall";
    
  }
}

var breweryfilePath = Os.homedir() + "/.breweryfile.json";

function tryCatch(fn, error) {
  try {
    return Curry._1(fn, /* () */0);
  }
  catch (exn){
    return error;
  }
}

function commandOfString(command) {
  var param = $$String.lowercase(command);
  switch (param) {
    case "help" : 
        return /* Help */0;
    case "init" : 
        return /* Init */3;
    case "install" : 
        return /* Install */2;
    case "list" : 
        return /* List */4;
    case "uninstall" : 
        return /* Uninstall */5;
    default:
      return /* Unknown */1;
  }
}

function getCommandAndArguments(args) {
  if (args) {
    return /* tuple */[
            commandOfString(args[0]),
            args[1]
          ];
  } else {
    return /* tuple */[
            /* Unknown */1,
            /* [] */0
          ];
  }
}

function parseArguments(args) {
  return $$Array.to_list($$Array.sub(args, 2, args.length - 2 | 0));
}

function writeBrewFile(writeFile, breweryfile) {
  var match = Brewconfig.toJson(breweryfile);
  if (match) {
    Curry._2(writeFile, breweryfilePath, match[0]);
    return /* Ok */Block.__(0, [/* () */0]);
  } else {
    return /* Error */Block.__(1, ["unable to create initial brewery.json"]);
  }
}

function loadBreweryConfig(readFile) {
  return tryCatch((function () {
                var param = Brewconfig.fromJson($$String.trim(Curry._1(readFile, breweryfilePath)));
                if (param.tag) {
                  return /* Error */Block.__(1, [param[0]]);
                } else {
                  return /* Ok */Block.__(0, [param[0]]);
                }
              }), /* Error */Block.__(1, ["Error loading " + (String(breweryfilePath) + "")]));
}

function getInstalledFormulas(exec) {
  return tryCatch((function () {
                var getInstalledFormulasFor = function (command) {
                  var leaves = Utils.stringOfBuffer(Curry._1(exec, command));
                  return List.map((function (s) {
                                return s;
                              }), $$Array.to_list($$String.trim(leaves).split("\n")));
                };
                return /* Ok */Block.__(0, [Brewconfig.make(getInstalledFormulasFor("brew leaves"), getInstalledFormulasFor("brew cask list"))]);
              }), /* Error */Block.__(1, ["error getting installed formulas"]));
}

function installBrew(exec) {
  return tryCatch((function () {
                Curry._1(exec, installBrewScript);
                Curry._1(exec, installCaskScript);
                return /* Ok */Block.__(0, [/* () */0]);
              }), /* Error */Block.__(1, ["error installing brew"]));
}

function isBrewInstalled(exec) {
  try {
    Curry._1(exec, "brew --version");
    return /* true */1;
  }
  catch (exn){
    return /* false */0;
  }
}

function installFormula(exec, args, breweryfile) {
  var getFormula = function () {
    if (List.hd(args) === "cask") {
      return /* tuple */[
              List.nth(args, 1),
              /* true */1
            ];
    } else {
      return /* tuple */[
              List.hd(args),
              /* false */0
            ];
    }
  };
  return Result.$great$great$eq(tryCatch((function () {
                    return /* Ok */Block.__(0, [getFormula(/* () */0)]);
                  }), /* Error */Block.__(1, ["No formula has been passed"])), (function (param) {
                var isCask = param[1];
                var formula = param[0];
                return Result.$less$$great(tryCatch((function () {
                                  Curry._1(exec, "brew " + (
                                        isCask ? "cask install " + (String(formula) + "") : "install " + (String(formula) + "")
                                      ));
                                  return /* Ok */Block.__(0, [/* () */0]);
                                }), /* Error */Block.__(1, ["Error installing " + (String(formula) + " formula")])), (function () {
                              return Brewconfig.add(breweryfile, isCask, formula);
                            }));
              }));
}

function uninstallFormula(exec, args, breweryfile) {
  var getFormula = function () {
    var match = +(List.hd(args) === "cask");
    if (match !== 0) {
      return /* tuple */[
              List.nth(args, 1),
              /* true */1
            ];
    } else {
      return /* tuple */[
              List.hd(args),
              /* false */0
            ];
    }
  };
  return Result.$great$great$eq(tryCatch((function () {
                    return /* Ok */Block.__(0, [getFormula(/* () */0)]);
                  }), /* Error */Block.__(1, ["No formula has been passed"])), (function (param) {
                var isCask = param[1];
                var formula = param[0];
                return Result.$less$$great(tryCatch((function () {
                                  Curry._1(exec, "brew " + (
                                        isCask ? "cask uninstall " + (String(formula) + "") : "uninstall " + (String(formula) + "")
                                      ));
                                  return /* Ok */Block.__(0, [/* () */0]);
                                }), /* Error */Block.__(1, ["Error uninstalling " + (String(formula) + " formula")])), (function () {
                              return Brewconfig.remove(breweryfile, isCask, formula);
                            }));
              }));
}

function installBrewIfNeeded(exec) {
  if (isBrewInstalled(exec)) {
    return /* Ok */Block.__(0, [/* () */0]);
  } else {
    return installBrew(exec);
  }
}

function execCommand(system, _param) {
  while(true) {
    var param = _param;
    var args = param[1];
    var command = param[0];
    switch (command) {
      case 0 : 
          return /* Ok */Block.__(0, ["\nHi from brewery üçª  here some help\n\nhelp                          - shows this output\ninit                          - creates .breweryfile.json in your HOME folder with the formulas that are currently installed in brew and brew cask\ninstall [cask] [formula]      - installs the formula and adds it to .breweryfile.json\nlist                          - shows the installed formulas\nuninstall [cask] [formula]    - uninstalls a formula and removes it from .breweryfile.json\n"]);
      case 1 : 
          if (List.length(args)) {
            Curry._1(system[/* log */0], "I don't know " + (commandToString(command) + " command"));
            return /* Error */Block.__(1, [commandToString(command)]);
          } else {
            _param = /* tuple */[
              /* Help */0,
              args
            ];
            continue ;
            
          }
          break;
      case 2 : 
          return Result.$great$great$eq(installBrewIfNeeded(system[/* exec */3]), (function(args){
                    return function () {
                      var partial_arg = system[/* exec */3];
                      var partial_arg$1 = system[/* writeFile */1];
                      var res = Result.$great$great$eq(Result.$great$great$eq(loadBreweryConfig(system[/* readFile */2]), (function (param) {
                                  return installFormula(partial_arg, args, param);
                                })), (function (param) {
                              return writeBrewFile(partial_arg$1, param);
                            }));
                      if (res.tag) {
                        return /* Error */Block.__(1, [res[0]]);
                      } else {
                        return /* Ok */Block.__(0, [".breweryfile.json updated"]);
                      }
                    }
                    }(args)));
      case 3 : 
          var writeBreweryfileIfDoesNotExists = function (breweryfile) {
            if (Curry._1(system[/* fileExists */4], breweryfilePath)) {
              return /* Error */Block.__(1, [breweryfilePath + " exists already"]);
            } else {
              return writeBrewFile(system[/* writeFile */1], breweryfile);
            }
          };
          return Result.$great$great$eq(installBrewIfNeeded(system[/* exec */3]), (function () {
                        var res = Result.$great$great$eq(getInstalledFormulas(system[/* exec */3]), writeBreweryfileIfDoesNotExists);
                        if (res.tag) {
                          return /* Error */Block.__(1, [res[0]]);
                        } else {
                          return /* Ok */Block.__(0, [".breweryfile.json created"]);
                        }
                      }));
      case 4 : 
          return Result.$great$great$eq(loadBreweryConfig(system[/* readFile */2]), (function (breweryConfig) {
                        var breweryConfigRes = Brewconfig.toJson(breweryConfig);
                        if (breweryConfigRes) {
                          return /* Ok */Block.__(0, [breweryConfigRes[0]]);
                        } else {
                          return /* Error */Block.__(1, ["\"Error converting " + (String(breweryConfig) + " to json")]);
                        }
                      }));
      case 5 : 
          var partial_arg = system[/* exec */3];
          var partial_arg$1 = system[/* writeFile */1];
          var res = Result.$great$great$eq(Result.$great$great$eq(loadBreweryConfig(system[/* readFile */2]), (function(args,partial_arg){
                  return function (param) {
                    return uninstallFormula(partial_arg, args, param);
                  }
                  }(args,partial_arg))), (function(partial_arg$1){
              return function (param) {
                return writeBrewFile(partial_arg$1, param);
              }
              }(partial_arg$1)));
          if (res.tag) {
            return /* Error */Block.__(1, [res[0]]);
          } else {
            return /* Ok */Block.__(0, [".breweryfile.json updated"]);
          }
          break;
      
    }
  };
}

function run(system, stdin) {
  var res = execCommand(system, getCommandAndArguments(parseArguments(stdin)));
  return Curry._1(system[/* log */0], res[0]);
}

function system_000(prim) {
  console.log(prim);
  return /* () */0;
}

function system_001(prim, prim$1) {
  Fs.writeFileSync(prim, prim$1, "utf8");
  return /* () */0;
}

function system_002(prim) {
  return Fs.readFileSync(prim, "utf8");
}

function system_003(command) {
  return Child_process.execSync(command, { });
}

function system_004(filePath) {
  return tryCatch((function () {
                Fs.readFileSync(filePath, "utf8");
                return /* true */1;
              }), /* false */0);
}

var system = /* record */[
  system_000,
  system_001,
  system_002,
  system_003,
  system_004
];

run(system, Process.argv);

exports.installBrewScript      = installBrewScript;
exports.installCaskScript      = installCaskScript;
exports.commandToString        = commandToString;
exports.breweryfilePath        = breweryfilePath;
exports.tryCatch               = tryCatch;
exports.commandOfString        = commandOfString;
exports.getCommandAndArguments = getCommandAndArguments;
exports.parseArguments         = parseArguments;
exports.writeBrewFile          = writeBrewFile;
exports.loadBreweryConfig      = loadBreweryConfig;
exports.getInstalledFormulas   = getInstalledFormulas;
exports.installBrew            = installBrew;
exports.isBrewInstalled        = isBrewInstalled;
exports.installFormula         = installFormula;
exports.uninstallFormula       = uninstallFormula;
exports.installBrewIfNeeded    = installBrewIfNeeded;
exports.execCommand            = execCommand;
exports.run                    = run;
exports.system                 = system;
/* breweryfilePath Not a pure module */
